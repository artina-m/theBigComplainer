<html>
    <head>
        <title>The Big Complainer</title>
        <script src="https://d3js.org/d3.v4.min.js"></script>
        <script src="http://d3js.org/topojson.v2.min.js"></script>
        <link rel = "stylesheet" type="text/css" href = "index.css">
    </head>

<body>

<div class = "visualization">

    <div class = "firstSection" id="firstDiv" >
            <h1 id = "mainTitle"> The Big Complainer</h1>
            <hr>
            <p id = "subTitle"> What are New Yorkers complaining about?</p>
            <p id = "blurb">Top 311 complaints in Manhattan for 2017</p>
                <svg id='svg1' width= 90% height=50%>
                </svg>
        
                <script>
                    var svg1 = document.getElementById('svg1');
                    var svgWidth = document.getElementById('firstDiv').offsetWidth;
                    var svgHeight = document.getElementById('firstDiv').offsetHeight/2;


                    pics = [{id:0, name:"noise res.svg", x:0, y:0}, {id:1, name:"heat water.svg", x:svgWidth/3, y:0}, {id:2, name:"illegal parking.svg", x:(svgWidth/3)*2, y:0}, {id:3, name:"blocked driveway.svg", x:0, y:svgHeight/3} , {id:4, name:"street.svg", x:svgWidth/3, y:svgHeight/3}, {id:5, name:"streetlight.svg", x:(svgWidth/3)*2, y:svgHeight/3}, {id:6, name:"unsanitary.svg", x:0, y:(svgHeight/3)*2}, {id:7, name:"noise street.svg", x:svgWidth/3, y:(svgHeight/3)*2}, {id:8, name:"water system.svg", x:(svgWidth/3)*2, y:(svgHeight/3)*2}];

                    var insert = d3.select("svg");
            
                   

                </script>        
    </div>

    <div class = "secondSection" id = "map">
    </div>

    <div class = "thirdSection">
    </div>

</div>

    
<script>

    // Nieghborhoods --- working on this
    
    color = "#227DDA"
        
    
    // Load Data
    function parseLine(line) {
        return {
            uniqueKey: Number(line["Unique Key"]),
            date: line["Created Date"],
            complaintType: line["Complaint Type"],
            zipcode: Math.floor(line["Incident Zip"]),
            latitude: Number(line["Latitude"]),
            longitude: Number(line["Longitude"]),
            nieghborhood: line["Neighborhood"]
        }
    }

    var complaintData;
    var nested;
    var c = 0;



    d3.tsv("ManhattanComplaints", parseLine, function(error,data){
        
        complaintData = data;
        
        // Nested: Complaint Type -> Zipcode -> Point details
        // Roll up to complaint type
        var nested_data = d3.nest()
            .key(function(d) { return d.complaintType; })
            .entries(complaintData);
        
        // Break into zipcodes
        for (nd in nested_data){
            com = nested_data[nd].values
            var nested_data2 = d3.nest()
                .key(function(d) { return Math.floor(d.zipcode); })
                .entries(com);
            com = nested_data2;
            nested_data[nd].values = com
        }
        
        nested = nested_data;
        
        
        // Map 
        var width = document.getElementById("map").clientWidth;
        var height = document.getElementById("map").clientHeight;
        var centered = 20;
        
        var projection = d3.geoMercator()
                .center([-74.04, 40.75])
                .scale(150000)
                .translate([(width/2 - 150), (height)/2 +100]);
        
        var path = d3.geoPath().projection(projection);
        
        var svg = d3.select(".secondSection").append("svg")
            .attr("width", "100%")
            .attr("height", "100%");
        
        svg.append("rect")
            .attr("class", "background")
            .attr("width", width)
            .attr("height", height)
            .attr("fill", "white")
            .on("click", clicked);
        
        var g = svg.append("g");
        
        
        // Click & Zoom
        function clicked(d) {
        var zoom;
        
        var x, y, k;

          if (d && centered !== d) {
            var centroid = path.centroid(d);
            x = centroid[0];
            y = centroid[1];
            k = 4;
            centered = d;
            zoom = "in"
          } else {
            x = 250;
            y = 350;
            k = 1;
            centered = null;
            zoom = "out"

          }
    
        g.selectAll("circle").remove()
        g.selectAll("path").classed("nonactive", function(d) { return d != centered;})
        g.selectAll("path").classed("active", centered && function(d) { return d === centered; });
            
            
        if (zoom == "out"){

            // Zooming out from the graph and adding back the heatmap
            g.selectAll("path")
                .transition()
                .duration(750)
                .attr("fill", function(d){ return fillMap(d,c)})
                .attr("stroke-wdith", 1.5 / k + "px")
        }
            
        else {
            
            // Zooming into the graph, highlighting zipcode
            g.selectAll("path").transition()
            .duration(750)
            .attr("fill", "lightgrey")
            
            g.selectAll(".active")
            .transition()
            .duration(750)
            .attr("fill", "#212F3D")
            .attr("opacity", 1)
            
            if (d.properties != undefined) {
                var code = d.properties.postalCode
            
                zipData = getZipDetails(code)

                g.selectAll("circle").data(zipData)
                .enter().append("circle")
                .attr("class", "complaintPoint")
                .attr("cx", function(d){
                    return projection([d.longitude, d.latitude])[0]})
                .attr("cy", function(d){
                    return projection([d.longitude, d.latitude])[1]})
                .attr("r", 0.4)
                .attr("fill", "#F5C141")
                .attr("opacity", 0.4)
            }
            
        }
          
        g.transition()
              .duration(750)
              .attr("transform", "translate(" + ((width / 2) )+ "," + ((height)/2) + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
              .style("stroke-width", 1.5 / k + "px");
            

            
        }
        
        
        function getZipDetails(code){
            cd = nested[c].values;
            
            
            for (i in cd){
                place = cd[i];
                if (cd[i].key == code){
                    return cd[i].values
                }
            }
            return []
        }
        
        // Populate map
        d3.json("nyc.geojson", function(error, nyb) {

            g.append("g")
                .attr("id", "postalCode")
                .selectAll(".state")
                .data(nyb.features)
                .enter().append("path")
                .attr("class", "zips")
                .attr("d", path)
                .attr("fill", function(d){ return fillMap(d,c)})
                .attr("stroke", "white")
                .on("click", clicked)
            });
        
        
        
        pics.forEach(function(d){
                        insert.append("svg:image")
                        .attr("xlink:href", d.name)
                            .attr("width", svgWidth/5-10)
                            .attr("height", svgHeight/5-10)
                            .attr("x", d.x)
                            .attr("y",d.y)
                            .on("click", function()
                                {c=d.id;
                                 x = 250;
                                y = 350;
                                 cd = nested[c];
                                 
                                 g.selectAll("path")
                                 .attr("fill", function(d){ return fillMap(d,c)})
                                 
                                 g.selectAll("circle").remove()
                                 
                                 g.transition()
                                .duration(750)
                                .attr("transform", "translate(" + ((width / 2) )+ "," + ((height)/2) + ")scale("  + ")translate(" + -x + "," + -y + ")")
                                .style("stroke-width", 1.5  + "px");
            
                                
                                
                                })
        }) 
                    
        

        //Begin heatmap read in 

         // Geneate Heat Map and mount to div class target_div

            // ====Notes for Heat Map====
            // Day of month is 0 indexed 0..11
            // Hours are in military time 0..23


            function convdate(entry){
                return {
                    uniqueKey: entry.uniqueKey,
                    date: new Date(entry.date),
                    complaintType: entry.complaintType,
                    zipcode: Number(entry.zipcode),
                    latitude: Number(entry.latitude),
                    longitude: Number(entry.longitude),
                    neighborhood: entry.nieghborhood
                }
            }

            function generateHeatMap(complaint_type, data, target_div, zip) {

                // if showing all zip codes, 'ALL'
                let zip_code = zip === "ALL" ? "ALL" : Number(zip);

                console.log("Entering generate heat map...");

                // convert date obj for all data
                // let curated_data = change2Date(data);
                let curated_data = data.map(entry=> convdate(entry));

                console.log(curated_data);

                // get objects of this specific complaint_type
                var post_processing_data = curated_data.filter(entry => entry.complaintType == complaint_type);
                console.log("DATA GOING INTO VISUALIZATION");
                console.log(post_processing_data);

                // if default view, use all zipcodes, else filter by the inputted zip code
                if (zip_code !== "ALL") {
                    post_processing_data = post_processing_data.filter(entry =>
                        Number(entry.zipcode) == zip_code);
                }

                // console.log("BEFORE ANYTHING")
                // console.log(post_processing_data);

                // console.log("BEGINNING LOOP");
                // curated data in Heatmap format
                let day_hour_val = [];

                // for each of the 7 days of the week
                for (i = 0; i < 7; i++) {
                    let day = post_processing_data.filter(entry => entry.date.getDay() == i
                    );
                    // console.log("DAY: ", i);
                    // console.log(day);
                    // for each of the 24 hours of the day
                    for (z = 0; z < 24; z++) {
                        // console.log("HOUR: ", z)
                        let hour = day.filter(day => day.date.getHours() == z);
                        // console.log(hour);
                        let count = hour.length;
                        day_hour_val.push({
                            zipcode: zip_code,
                            complaint_type: complaint_type,
                            day: i,
                            hour: z,
                            value: count
                        });
                    }
                }


                // console.log(day_hour_val);
                var sum = 0
                day_hour_val.forEach(entry => sum += entry.value);
                // console.log(sum);

                var x;
                var highest = 0
                day_hour_val.forEach(function (element) {
                    if (element.value > highest) {
                        x = element;
                        highest = element.value;
                    }
                }, this);
                // console.log(x);



                // Visualization

                // https://jsfiddle.net/henbox/d3y14zsq/1/
                // http://bl.ocks.org/ganezasan/dfe585847d65d0742ca7d0d1913d50e1

                let margin = { top: 20, right: 10, bottom: 10, left: 20 },
                    height = 800 - margin.left - margin.right,
                    width = 500 - margin.top - margin.bottom,
                    gridSize = Math.floor(width / 24),
                    legendElementWidth = gridSize * 2,
                    buckets = 9,
                    colors = ["#ffffd9", "#edf8b1", "#c7e9b4", "#7fcdbb", "#41b6c4", "#1d91c0", "#225ea8", "#253494", "#081d58"], // alternatively colorbrewer.YlGnBu[9]
                    days = ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"],
                    times = ["12p", "1a", "2a", "3a", "4a", "5a", "6a", "7a", "8a", "9a", "10a", "11a", "12p", "1p", "2p", "3p", "4p", "5p", "6p", "7p", "8p", "9p", "10p", "11p"];

                // datasets = ["data.tsv", "data2.tsv"];

                let svg = d3.select(target_div).append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                let dayLabels = svg.selectAll(".dayLabel")
                    .data(days)
                    .enter().append("text")
                    .text(function (d) { return d; })
                    .attr("x", function (d, i) { return i * gridSize + 40; })
                    .attr("y", 0)
                    .style("text-anchor", "end")
                    // .attr("transform", "translate(-6," + gridSize / 1.5 + ")")
                    .attr("class", function (d, i) { return ((i >= 0 && i <= 4) ? "dayLabel mono axis axis-workweek" : "dayLabel mono axis axis-workweek"); });

                let timeLabels = svg.selectAll(".timeLabel")
                    .data(times)
                    .enter().append("text")
                    .text(function (d) { return d; })
                    .attr("x", 0)
                    .attr("y", function (d, i) { return i * gridSize + 40; })
                    .style("text-anchor", "middle")
                    .attr("transform", "translate(" + gridSize / 2 + ", -6)")
                    .attr("class", function (d, i) { return ((i >= 7 && i <= 16) ? "timeLabel mono axis axis-worktime" : "timeLabel mono axis axis-worktime"); });


                const colorScale = d3.scaleQuantile()
                    .domain([0, buckets - 1, d3.max(day_hour_val, function (d) { return d.value; })])
                    .range(colors);


                const cards = svg.selectAll(".hour")
                    .data(day_hour_val, function (d) { return d.day + ':' + d.hour; });

                cards.append("title");

                cards.enter().append("rect")
                    .attr("x", function (d) { return (d.day - 1) * gridSize + 40; })
                    .attr("y", function (d) { return (d.hour - 1) * gridSize + 40; })
                    .attr("rx", 4)
                    .attr("ry", 4)
                    .attr("class", "hour bordered")
                    .attr("width", gridSize)
                    .attr("height", gridSize)
                    .style("fill", colors[0])
                    .merge(cards)
                    .transition()
                    .duration(1000)
                    .style("fill", (d) => colorScale(d.value));

                // cards.transition().duration(1000)
                //         .style("fill", function (d) { return colorScale(d.value); });

                cards.select("title").text(function (d) { return d.value; });

                cards.exit().remove();


                // var legend = svg.selectAll(".legend")
                //         .data([0].concat(colorScale.quantiles()), function (d) { return d; });

                //     legend.enter().append("g")
                //         .attr("class", "legend");

                //     legend.append("rect")
                //         .attr("x", function (d, i) { return legendElementWidth * i; })
                //         .attr("y", height)
                //         .attr("width", legendElementWidth)
                //         .attr("height", gridSize / 2)
                //         .style("fill", function (d, i) { return colors[i]; });

                //     legend.append("text")
                //         .attr("class", "mono")
                //         .text(function (d) { return "â‰¥ " + Math.round(d); })
                //         .attr("x", function (d, i) { return legendElementWidth * i; })
                //         .attr("y", height + gridSize);

                //     legend.exit().remove();






            } //end generateHeatMap


            // take in complaint_type, raw data, and the target div
            // generateHeatMap("Noise - Residential", data, ".thirdSection", "10004")
            // 29

            // generateHeatMap("Noise - Residential", data, ".thirdSection", "ALL")
            // 50452

            generateHeatMap("UNSANITARY CONDITION", data, ".thirdSection", "ALL")
            // 14430

            // generateHeatMap("Noise - Residential", complaintData, ".thirdSection", "10031")
            // 4352

            // generateHeatMap("UNSANITARY CONDITION", data, ".thirdSection", "10031")
            // 1417
        

        
    })
    
    
    
     
    
</script>
    
    
    
<!--- Helper Functions -->

<script>
    
    // Call to change into date
    function change2Date(data){
        var i=0;
        console.log("Entering change2date");
        console.log(data);
        while(i<data.length){
            if(data[i].date.substring(20,22) == "PM"){
                data[i].date = new Date(2017,
                    //month 00 is January
                    Number(data[i].date.substring(0,2))-1,
                    Number(data[i].date.substring(3,5)),
                    //adding 12 hours if it is PM
                    Number(data[i].date.substring(11,13)+12),
                    Number(data[i].date.substring(14,16)),
                    Number(data[i].date.substring(17,19)));
                    i++;
            }    
            else{
                data[i].date = new Date(2017, Number(data[i].date.substring(0,2))-1, Number(data[i].date.substring(3,5)), Number(data[i].date.substring(11,13)), Number(data[i].date.substring(14,16)),
                Number(data[i].date.substring(17,19)));
                i++;
            } 
        }
        return complaintData;
    }
    
        
    function neighborhoodKey(name){
        if (name == "Inwood and Washington Heights"){return 0};
        if (name == "Central Harlem") {return 1};
        if (name == "Lower East Side") {return 2};
        if (name == "Lower Manhattan") {return 3};
        if (name == "Upper East Side") {return 4};
        if (name == "Greenwhich Village and Soho") {return 5};
        if (name == "East Harlem") {return 6};
        if (name == "Upper West Side") {return 7};
        if (name == "Gramercy Park and Murray Hill") {return 8};
        if (name == "Chelsea and Clinton") {return 9};
        return 11;
    }
    
    
    colorScale = d3.scaleLinear().domain([100,1000])
      .interpolate(d3.interpolateHcl)
      .range([ '#F7DC6F',"#F5B041","#E74C3C"]);
    
    
    // Call to change neighborhood data on map
    function fillMap(d,c){
        var zipCode = d.properties.postalCode
        
        cd = nested[c].values
        
        for (c in cd){
            if (cd[c].key.includes(zipCode)){
                num = cd[c].values.length
                return colorScale(num)
            }
        }
       return "lightGrey"
            
    }
    
    


</script>
    
    
</body>

<!-- Refrences -->
    
</html>