<html>
    <head>
        <title>The Big Complainer</title>
        <script src="https://d3js.org/d3.v4.min.js"></script>
        <script src="http://d3js.org/topojson.v2.min.js"></script>
        <link rel = "stylesheet" type="text/css" href = "index.css">
    </head>

<body>

<div class = "visualization">

        <div class = "firstSection">
            <h1> The Big Complainer</h1>
        </div>

        <div class = "secondSection", id = "map">
        </div>

        <div class = "thirdSection">
        </div>

</div>

    
<script>

    // Nieghborhoods --- working on this
    
    color = "#227DDA"
        
    
    // Load Data
    function parseLine(line) {
        return {
            uniqueKey: Number(line["Unique Key"]),
            date: line["Created Date"],
            complaintType: line["Complaint Type"],
            zipcode: Math.floor(line["Incident Zip"]),
            latitude: Number(line["Latitude"]),
            longitude: Number(line["Longitude"]),
            nieghborhood: line["Neighborhood"]
        }
    }

    var complaintData;
    var nested;
    var c = 0;
    
    var colorScale = d3.scaleLinear()
        .domain([100,1000])
        .range([0.2, 1]);


    d3.tsv("ManhattanComplaints", parseLine, function(error,data){
        
        complaintData = data;
        
        // Nested: Complaint Type -> Zipcode -> Point details
        // Roll up to complaint type
        var nested_data = d3.nest()
            .key(function(d) { return d.complaintType; })
            .entries(complaintData);
        
        // Break into zipcodes
        for (nd in nested_data){
            com = nested_data[nd].values
            var nested_data2 = d3.nest()
                .key(function(d) { return Math.floor(d.zipcode); })
                .entries(com);
            com = nested_data2;
            nested_data[nd].values = com
        }
        
        nested = nested_data;
        
        
        // Map 
        var width = document.getElementById("map").clientWidth;
        var height = document.getElementById("map").clientHeight;
        var centered = 20;
        
        var projection = d3.geoMercator()
                .center([-74.04, 40.75])
                .scale(150000)
                .translate([(width/2 - 150), (height)/2 +100]);
        
        var path = d3.geoPath().projection(projection);
        
        var svg = d3.select(".secondSection").append("svg")
            .attr("width", "100%")
            .attr("height", "100%");
        
        svg.append("rect")
            .attr("class", "background")
            .attr("width", width)
            .attr("height", height)
            .attr("fill", "white")
            .on("click", clicked);
        
        var g = svg.append("g");
        
        
        // Click & Zoom
        function clicked(d) {
        var zoom;
        
        var x, y, k;

          if (d && centered !== d) {
            var centroid = path.centroid(d);
            x = centroid[0];
            y = centroid[1];
            k = 4;
            centered = d;
            zoom = "in"
          } else {
            x = 250;
            y = 350;
            k = 1;
            centered = null;
            zoom = "out"

          }
    
        g.selectAll("circle").remove()
        g.selectAll("path").classed("nonactive", function(d) { return d != centered;})
        g.selectAll("path").classed("active", centered && function(d) { return d === centered; });
            
            
        if (zoom == "out"){

            // Zooming out from the graph and adding back the heatmap
            g.selectAll("path")
                .transition()
                .duration(750)
                .attr("fill", function(d){ return fillMap(d,c)})
                .attr("stroke-wdith", 1.5 / k + "px")
        }
            
        else {
            
            // Zooming into the graph, highlighting zipcode
            g.selectAll("path").transition()
            .duration(750)
            .attr("fill", "lightgrey")
            
            g.selectAll(".active")
            .transition()
            .duration(750)
            .attr("fill", "#212F3D")
            .attr("opacity", 1)
            
            if (d.properties != undefined) {
                var code = d.properties.postalCode
            
                zipData = getZipDetails(code)

                g.selectAll("circle").data(zipData)
                .enter().append("circle")
                .attr("class", "complaintPoint")
                .attr("cx", function(d){
                    return projection([d.longitude, d.latitude])[0]})
                .attr("cy", function(d){
                    return projection([d.longitude, d.latitude])[1]})
                .attr("r", 0.4)
                .attr("fill", "white")
                .attr("opacity", 0.4)
            }
            
        }
          
        g.transition()
              .duration(750)
              .attr("transform", "translate(" + ((width / 2) )+ "," + ((height)/2) + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
              .style("stroke-width", 1.5 / k + "px");
            

            
        }
        
        
        function getZipDetails(code){
            cd = nested[c].values;
            
            for (i in cd){
                place = cd[i];
                if (cd[i].key == code){
                    return cd[i].values
                }
            }
            return []
        }
        
        // Populate map
        d3.json("nyc.geojson", function(error, nyb) {

            g.append("g")
                .attr("id", "postalCode")
                .selectAll(".state")
                .data(nyb.features)
                .enter().append("path")
                .attr("class", "zips")
                .attr("d", path)
                .attr("fill", function(d){ return fillMap(d,c)})
                .attr("stroke", "white")
                .on("click", clicked)
            });
    })
    
</script>
    
    
    
<!--- Helper Functions -->

<script>
    
    // Call to change into date
    function change2Date(data){
        var i=0;
        while(i<data.length){
            if(data[i].date.substring(20,22) == "PM"){
                data[i].date = new Date(2017,
                    //month 00 is January
                    Number(data[i].date.substring(0,2))-1,
                    Number(data[i].date.substring(3,5)),
                    //adding 12 hours if it is PM
                    Number(data[i].date.substring(11,13)+12),
                    Number(data[i].date.substring(14,16)),
                    Number(data[i].date.substring(17,19)));
                    i++;
            }    
            else{
                data[i].date = new Date(2017, Number(data[i].date.substring(0,2))-1, Number(data[i].date.substring(3,5)), Number(data[i].date.substring(11,13)), Number(data[i].date.substring(14,16)),
                Number(data[i].date.substring(17,19)));
                i++;
            } 
        }
        return complaintData;
    }
    
        
    function neighborhoodKey(name){
        if (name == "Inwood and Washington Heights"){return 0};
        if (name == "Central Harlem") {return 1};
        if (name == "Lower East Side") {return 2};
        if (name == "Lower Manhattan") {return 3};
        if (name == "Upper East Side") {return 4};
        if (name == "Greenwhich Village and Soho") {return 5};
        if (name == "East Harlem") {return 6};
        if (name == "Upper West Side") {return 7};
        if (name == "Gramercy Park and Murray Hill") {return 8};
        if (name == "Chelsea and Clinton") {return 9};
        return 11;
    }
    
    
    colorScale = d3.scaleLinear().domain([100,1000])
      .interpolate(d3.interpolateHcl)
      .range([ '#F7DC6F',"#F5B041","#E74C3C"]);
    
    
    // Call to change neighborhood data on map
    function fillMap(d,c){
        var zipCode = d.properties.postalCode
        
        cd = nested[c].values
        
        for (c in cd){
            if (cd[c].key.includes(zipCode)){
                num = cd[c].values.length
                return colorScale(num)
            }
        }
       return "lightGrey"
            
    }
    
    


</script>
    
    
</body>

<!-- Refrences -->
    
</html>