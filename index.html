<html>
    <head>
        <title>The Big Complainer</title>
        <script src="https://d3js.org/d3.v4.min.js"></script>
        <script src="http://d3js.org/topojson.v2.min.js"></script>
        <link rel = "stylesheet" type="text/css" href = "index.css">
    </head>

<body>

<div class = "visualization">

        <div class = "firstSection">
            <h1> The Big Complainer</h1>
        </div>

        <div class = "secondSection">
        </div>

        <div class = "thirdSection">
        </div>

</div>

    
<script>

    // Nieghborhoods --- working on this
    neigh = {
        "Central Harlem": {zipcodes: ["10026", "10027", "10030", "10037", "10039"],
                    name: "Central Harlem",
                    noiseR: 0,heatHotWater:0,illegalParking: 0, blockedDriveway: 0, streetCondition:0, streetLightCondition:0, unsanitaryCondition:0, noiseS:0,waterSystem:0},
        "Chelsea and Clinton": {zipcodes: ["10001", "10011", "10018", "10019", "10020", "10036"],
                    name: "Chelsea and Clinton",
                    noiseR: 0,heatHotWater:0,illegalParking: 0, blockedDriveway: 0, streetCondition:0, streetLightCondition:0, unsanitaryCondition:0, noiseS:0,waterSystem:0},
        "East Harlem": {zipcodes: ["10029","10035"],
                    name: "East Harlem",
                    noiseR: 0,heatHotWater:0,illegalParking: 0, blockedDriveway: 0, streetCondition:0, streetLightCondition:0, unsanitaryCondition:0, noiseS:0,waterSystem:0},
        "Gramercy Park and Murray Hill": {zipcodes: ["10010", "10016", "10017", "10022"],
                    name: "Gramercy Park and Murray Hill",
                    noiseR: 0,heatHotWater:0,illegalParking: 0, blockedDriveway: 0, streetCondition:0, streetLightCondition:0, unsanitaryCondition:0, noiseS:0,waterSystem:0},
        "Greenwhich Village and Soho": {zipcodes: ["10012", "10013", "10014"],
                    name: "Greenwhich Village and Soho",
                    noiseR: 0,heatHotWater:0,illegalParking: 0, blockedDriveway: 0, streetCondition:0, streetLightCondition:0, unsanitaryCondition:0, noiseS:0,waterSystem:0},
        "Lower Manhattan": {zipcodes: ["10004", "10005", "10006", "10007", "10038", "10280"],
                    name: "Lower Manhattan",
                    noiseR: 0,heatHotWater:0,illegalParking: 0, blockedDriveway: 0, streetCondition:0, streetLightCondition:0, unsanitaryCondition:0, noiseS:0,waterSystem:0},
        "Lower East Side": {zipcodes: ["10002", "10003", "10009"],
                    name: "Lower East Side",
                    noiseR: 0,heatHotWater:0,illegalParking: 0, blockedDriveway: 0, streetCondition:0, streetLightCondition:0, unsanitaryCondition:0, noiseS:0,waterSystem:0},
        "Upper East Side": {zipcodes: ["10021", "10028","10044", "10065", "10075", "10128"],
                    name: "Upper East Side",
                    noiseR: 0,heatHotWater:0,illegalParking: 0, blockedDriveway: 0, streetCondition:0, streetLightCondition:0, unsanitaryCondition:0, noiseS:0,waterSystem:0},
        "Upper West Side": {zipcodes: ["10023", "10024","10025"],
                    name: "Upper West Side",
                    noiseR: 0,heatHotWater:0,illegalParking: 0, blockedDriveway: 0, streetCondition:0, streetLightCondition:0, unsanitaryCondition:0, noiseS:0,waterSystem:0},
        "Inwood and Washington Heights": {zipcodes: ["10031", "10032", "10033", "10034", "10040"],
                    name: "Inwood and Washington Heights",
                    noiseR: 0,heatHotWater:0,illegalParking: 0, blockedDriveway: 0, streetCondition:0, streetLightCondition:0, unsanitaryCondition:0, noiseS:0,waterSystem:0}
    };
    
       
    // Load Data
    function parseLine(line) {
        return {
            uniqueKey: Number(line["Unique Key"]),
            date: line["Created Date"],
            complaintType: line["Complaint Type"],
            zipcode: line["Incident Zip"],
            latitude: Number(line["Latitude"]),
            longitude: Number(line["Longitude"]),
            nieghborhood: line["Neighborhood"]
        }
    }

    var complaintData;
    var nested;
    
    var colorScale = d3.scaleLinear()
        .domain([100,5000])
        .range([0.2, 1]);


    d3.tsv("ManhattanComplaints", parseLine, function(error,data){
        
        complaintData = data;
        
        // Nested: Complaint Type -> Neighborhood -> Point details
        // Roll up to complaint type
        var nested_data = d3.nest()
            .key(function(d) { return d.complaintType; })
            .entries(complaintData);
        
        // Break into nieghborhood types
        for (nd in nested_data){
            com = nested_data[nd].values
            var nested_data2 = d3.nest()
                .key(function(d) { return d.nieghborhood; })
                .entries(com);
            com = nested_data2;
            nested_data[nd].values = com
        }
        
        nested = nested_data;
        
        
        // Map 
        var width = 200;
        var height = 500;
        var centered = 20;
        
        var projection = d3.geoMercator()
                .center([-74.04, 40.75])
                .scale(180000)
                .translate([(width/2 - 100), (height)/2+180]);
        
        var path = d3.geoPath().projection(projection);
        
        var svg = d3.select(".secondSection").append("svg")
            .attr("width", "100%")
            .attr("height", "100%");
        
        svg.append("rect")
            .attr("class", "background")
            .attr("width", width)
            .attr("height", height)
            .attr("fill", "white")
            .on("click", clicked);
        
        var g = svg.append("g");
        
        
        // Click & Zoom
        function clicked(d) {
        var zoom;
        var x, y, k;

          if (d && centered !== d) {
            var centroid = path.centroid(d);
            x = centroid[0];
            y = centroid[1];
            k = 4;
            centered = d;
            zoom = "in"
          } else {
            x = width / 1.5;
            y = height / 1.5;
            k = 1;
            centered = null;
            zoom = "out"

          }

        g.selectAll("path").classed("nonactive", function(d) { return d != centered;})
        g.selectAll("path").classed("active", centered && function(d) { return d === centered; });
            
            
        if (zoom == "out"){
            // Zooming out from the graph and adding back the heatmap
            g.selectAll("path").attr("fill", "#FF5733")
                .attr("opacity", function(d){  return fillMap(d,c)})
                .transition()
                .duration(750)
                .attr("fill", "#FF5733")
                .attr("stroke-wdith", 1.5 / k + "px")
            
        }
        else {
            // Zooming into the graph, highlighting zipcode
            g.selectAll("path").transition()
            .duration(750)
            .attr("fill", "lightgrey")
            
            g.selectAll(".active")
            .transition()
            .duration(750)
            .attr("fill", "#2C3E50")
            .attr("stroke-width", 1)
            .attr("opacity", 1)
        }
            
        g.transition()
              .duration(750)
              .attr("transform", "translate(" + ((width / 2)+100 )+ "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
              .style("stroke-width", 1.5 / k + "px");
            
        }
        
        // Populate map
        d3.json("nyc.geojson", function(error, nyb) {

            c = 0; // complaint type

            g.append("g")
                .attr("id", "postalCode")
                .selectAll(".state")
                .data(nyb.features)
                .enter().append("path")
                .attr("class", "zips")
                .attr("d", path)
                .attr("fill", "#FF5733")
                .attr("opacity", function(d){ return fillMap(d,c)})
                .attr("stroke", "white")
                .on("click", clicked)
            });

    })
    

</script>
    
    
    
<!--- Helper Functions -->

<script>
    
    // Call to change into date
    function change2Date(data){
        var i=0;
        while(i<data.length){
            if(data[i].date.substring(20,22) == "PM"){
                data[i].date = new Date(2017,
                    //month 00 is January
                    Number(data[i].date.substring(0,2))-1,
                    Number(data[i].date.substring(3,5)),
                    //adding 12 hours if it is PM
                    Number(data[i].date.substring(11,13)+12),
                    Number(data[i].date.substring(14,16)),
                    Number(data[i].date.substring(17,19)));
                    i++;
            }    
            else{
                data[i].date = new Date(2017, Number(data[i].date.substring(0,2))-1, Number(data[i].date.substring(3,5)), Number(data[i].date.substring(11,13)), Number(data[i].date.substring(14,16)),
                Number(data[i].date.substring(17,19)));
                i++;
            } 
        }
        return complaintData;
    }
    
        
    function neighborhoodKey(name){
        if (name == "Inwood and Washington Heights"){return 0};
        if (name == "Central Harlem") {return 1};
        if (name == "Lower East Side") {return 2};
        if (name == "Lower Manhattan") {return 3};
        if (name == "Upper East Side") {return 4};
        if (name == "Greenwhich Village and Soho") {return 5};
        if (name == "East Harlem") {return 6};
        if (name == "Upper West Side") {return 7};
        if (name == "Gramercy Park and Murray Hill") {return 8};
        if (name == "Chelsea and Clinton") {return 9};
        return 11;
    }
    
    
    // Call to change neighborhood data on map
    function fillMap(d,c){
        var zipCode = d.properties.postalCode
        
        // Map zipcode to neighborhood
        var hood = 'Other'
        for (n in neigh){ 
            if (neigh[n].zipcodes.includes(zipCode)) {
                hood = n
            } 
        }
        
        if (hood != "Other"){
            k = neighborhoodKey(hood);
            if (k == 11) {return 0.1} // Not in mapping
            hoodData = (nested[c].values[k].values).length
            return colorScale(hoodData)
        }
        else {return 0.1}
    }
    
    



</script>
    
    
</body>

<!-- Refrences -->
    
</html>